# ADR 0005: API 認証を X-User-Id から Bearer トークンへ移行する

Status: Accepted

Relevant PR: （未作成）

# Context

- 現状の API は認証ヘッダとして `X-User-Id` を要求しているだけで、なりすましを防げない。
- docs/design/api-schema.md では Bearer トークン前提になっており、後続の予約・枠操作の整合性や不正予約防止のためにも早期にトークン認証へ移行する必要がある。
- 将来の店舗向け管理 API でも同じ認証機構を使い回したい。

## References

- docs/design/api-schema.md（認証: Bearer トークン想定）
- ADR 0001/0002（モデル/整合性方針） — 認証詳細は未定義

# Decision

- 認証ヘッダを `Authorization: Bearer <token>` に統一し、`X-User-Id` は廃止する。
- トークン検証はサーバ側で実施し、成功時に `user_id` をコンテキストに設定してユースケースへ渡す。
- 初期実装は簡易なトークン（例: HS256 署名の JWT）でユーザーIDをエンコードし、`users` テーブルに存在するかを確認する最小構成とする。将来 OIDC 等へ置換可能な構造にしておく（依存を隔離）。
- トークンはアクセストークンのみを採用し、短期有効期限（例: 30〜60分）とする。リフレッシュトークンは導入しない前提。
- 本ADRのスコープは「受け側のトークン検証とヘッダ仕様の統一」に限定し、サインアップ/ログインでのトークン発行フローは別タスク（必要なら別ADR）で設計・実装する。
- FastAPI の Depends (`get_current_user_id`) をトークン検証版に差し替え、すべてのエンドポイントで共通利用する。
- 認証失敗時は 401（WWW-Authenticate: Bearer）を返す。存在しないユーザーIDの場合も 401 とする。
- 空き枠検索 `/shops/{id}/slots/availability` も含めて Bearer 必須とし、非ログイン利用は不可とする（UIでのログイン導線強化によるユーザー獲得を優先）。
- `AUTH_SECRET` は必須環境変数とし、未設定時は起動時に例外を投げてプロセスを停止する（設定漏れの早期検知を優先）。運用上、起動後の HTTP レスポンスで通知する要件は設けない。

## Reason

- なりすまし防止と API スキーマ整合のため。現状のヘッダでは外部から簡単に予約/枠作成ができてしまう。
- Bearer トークンに統一しておくことで、後続の店舗向け API や将来の認可拡張（ロール/権限）にスムーズに拡張できる。
- JWT（HS256）程度であれば依存が軽く、既存の構成に最小限の変更で導入できる。
- リフレッシュトークンを省くことで初期実装をシンプルに保ち、秘密鍵管理と署名検証に集中できる。

# Consequences

- すべてのリクエストに Bearer トークンが必須となり、`X-User-Id` は受け付けなくなる。
- 認証処理が追加されるため、設定値（シークレット、アルゴリズム、許容発行者/オーディエンスなど）を `config` に持たせ、テスト用のトークンユーティリティが必要になる。
- 認証ミドルウェア/Depends を導入し、既存のルータをそれに置き換える必要がある。
