# ADR 0003: 予約変更/リスケのルール
- Status: Accepted (draft)
- Date: 2025-11-25

## 文脈 / Context
- ユーザーが確定済み予約を別の時間帯に移動したい需要がある。
- ダブルブッキング防止と一貫したキャンセルポリシーを維持したまま、最小限の変更機能を追加したい。
- 既存ドメインでは version による同時更新防止と `SELECT ... FOR UPDATE` によるスロットロックを採用している（ADR 0002）。

## 決定 / Decision
- 変更対象: 状態が `booked` の予約に限り、同一店舗内の他のオープンな枠へ「リスケ」を許可する。別店舗への移動は不可（別予約扱い）。
- カットオフ: 現在の予約開始時刻の 2 日前以降はリスケ不可（キャンセルと同じ猶予）。
- 検証:
  - If-Match または Body.version によるバージョン必須。ミスマッチは 409。
  - 変更先スロットは `open`、かつ `capacity - reserved >= party_size`、かつ同一ユーザーがそのスロットに既にアクティブ予約を持っていないこと。
  - 変更先スロットを `SELECT ... FOR UPDATE` でロックし、予約行も FOR UPDATE で取得して更新する。
- 振る舞い:
  - エンドポイント: `POST /me/reservations/{reservation_id}/reschedule`
  - 入力: `{ "slot_id": number }`（version は If-Match または Body.version で指定可）
  - 成功時: 200 / `ReservationRead` を返す。予約の `slot_id` を変更し、`version` を +1、`updated_at` を更新。ステータスは `booked` のまま。
  - 同一スロットへのリスケ要求は冪等で、バージョンが正しければそのまま返す。
- エラー:
  - 400: version 不正（<1 など）
  - 403: カットオフ内、または予約ステータスが変更不可（`cancelled` 等）
  - 404: 予約未検出、または変更先スロットが存在しない/`open` でない
  - 409: version 競合、容量超過、同一スロットへの重複予約

## 影響 / Consequences
- API が 1 本増える。I/O スキーマとテストの追加が必要。
- 予約変更でも version を進めるため、クライアントは最新バージョンを取得してからリスケを送る必要がある。
- 店舗跨ぎの移動は今後の別要件として扱う（別予約＋キャンセルを検討）。

## 今後の課題 / Open Questions
- パーティサイズ変更をリスケと同時に許可するか（現状は変更不可）。
- カットオフ時間やペナルティ設定を可変にするか。
- スタッフによる強制リスケ（別の権限制御）が必要か。
