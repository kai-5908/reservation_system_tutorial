# スロット空き判定と滞在時間に関するメモ（省略なしの説明）

## 課題

- ユーザーインターフェースがすごく難しく誤解を招く
  - 終了日時に何を入れればよいか直感的にわからない
  - 人数が入力できない

- **スロットと滞在時間の関係**: 現在は1つのスロットに開始時刻と終了時刻があるだけのモデルになっている。ユーザーの滞在時間（例: 2時間）を考慮して検索・予約を成立させるには、次のどちらかが必要になる。  
  1) スロットの長さ自体が滞在時間以上であることを必須条件とする。  
  2) 複数の連続するスロットを結合して1つの滞在時間を満たすロジックを実装する。

- **時間判定の境界条件**: ユーザーが入力した開始時刻がスロットの受け入れ可能時間に含まれ、なおかつ滞在時間分の余白があることを明示的に条件にする。例えば `slot.starts_at <= desired_start < slot.ends_at - dwell_time` のような式で、滞在時間をまるごと含むかどうかを判定する方針を決める。

- **店舗ごとのデフォルト滞在時間**: 店舗単位で `default_dwell_minutes` のような設定値を追加し、ユーザーが滞在時間を指定しなかった場合はその店舗のデフォルト値を使用する設計にする。

- **人数と空席判定の方法**: 現在の capacity は「上限値」を表すだけなので、指定時間帯に重なる既存予約の `party_size` 合計を計算し、希望人数を収容できるだけの空きが残っているかを判定するロジックを追加する必要がある。

- **フロント/バックエンドの入力項目とスキーマ**: 検索フォームで `party_size`（予約人数）と任意の `dwell_time`（未指定なら店舗デフォルトを適用）を受け取れるようにし、それに合わせてAPIスキーマを拡張する。バックエンドでもこれらの値を使って空き判定を行う。

- **業務ルールとの整合性**: 営業時間、close/blocked 状態、キャンセルカットオフなど、既存のビジネスルールに新しい滞在時間判定が矛盾しないことを確認する。必要に応じて優先順位やエラーメッセージの扱いを定義する。

- **タイムゾーンの取り扱い**: フロントでの入力は JST 前提に統一し、バックエンドでは受け取った時刻を UTC に正規化してから判定を行う。これにより検索・予約ロジックがタイムゾーン差異の影響を受けにくくなる。
